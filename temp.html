<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Vditor IR</title>

  <!-- Vditor -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/vditor/dist/index.css">
  <script src="https://cdn.jsdelivr.net/npm/vditor/dist/index.min.js"></script>

  <!-- Mermaid -->
  <script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>

  <style>
    :root { --bg: transparent; --mmd-font: 20px; }
    html, body { margin:0; padding:0; background: var(--bg); }
    #vditor { height: 100vh; }

    /* --- Mermaid base scaling via container font-size --- */
    .mermaid { 
      font-size: 20px !important;
      zoom: 1.3;  /* æ•´ä½“æ”¾å¤§ 1.3 å€ */
      transform-origin: top left;
    }
    .mermaid svg text { 
      font-size: 20px !important;
      font-family: -apple-system, 'SF Pro Text', sans-serif !important;
    }

    /* --- Dark content readability for Markdown preview/content --- */
    .vditor--dark .vditor-reset { color: #c9d1d9; }
    
    /* --- å›¾ç‰‡æ€§èƒ½ä¼˜åŒ– --- */
    .vditor-reset img {
      max-width: 100%;
      height: auto;
      image-rendering: -webkit-optimize-contrast;
      will-change: transform;
    }
    
    /* å¤§å›¾ç‰‡åŠ è½½æ—¶æ˜¾ç¤ºå ä½ç¬¦ */
    .vditor-reset img[src^="data:"] {
      background: #f0f0f0;
      min-height: 100px;
    }
    
    .vditor--dark .vditor-reset img[src^="data:"] {
      background: #2b2b2b;
    }
    
    /* æœ¬åœ°å›¾ç‰‡è·¯å¾„å¤„ç† */
    .vditor-reset img[src^="Images/"],
    .vditor-reset img[src^="./Images/"],
    .vditor-reset img[src*="/Images/"] {
      max-width: 100%;
      height: auto;
      cursor: default;
      display: block;
    }
    
    /* å›¾ç‰‡åŠ è½½å¤±è´¥æ—¶çš„æ ·å¼ */
    .vditor-reset img:not([src=""]) {
      min-width: 100px;
      min-height: 100px;
      background: #f0f0f0 url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><text x="50%" y="50%" text-anchor="middle" dy=".3em" fill="%23999">å›¾ç‰‡åŠ è½½ä¸­...</text></svg>') center no-repeat;
    }
    .vditor--dark .vditor-reset h1,
    .vditor--dark .vditor-reset h2,
    .vditor--dark .vditor-reset h3,
    .vditor--dark .vditor-reset h4,
    .vditor--dark .vditor-reset h5,
    .vditor--dark .vditor-reset h6 { color: #e6edf3; }
    .vditor--dark .vditor-reset a { color: #58a6ff; }
    .vditor--dark .vditor-reset code,
    .vditor--dark .vditor-reset pre {
      background: #161b22;
      color: #c9d1d9;
      border-color: #30363d;
    }
  </style>
</head>
<body>
  <div id="vditor"></div>

  <script>
  (function(){
    // -------- Mermaid ä¸»é¢˜é…ç½®ï¼ˆä¸ç›‘å¬ç³»ç»Ÿï¼‰--------
    function currentMermaidConfig(dark){
      const shared = {
        startOnLoad: false,
        securityLevel: 'loose',
        fontFamily: "-apple-system, 'SF Pro Text', 'Segoe UI', Arial, sans-serif",
        flowchart: { useMaxWidth: true, htmlLabels: true, curve: 'basis', padding: 8, nodeSpacing: 40, rankSpacing: 40 }
      };
      return dark ? {
        ...shared,
        theme: 'dark',
        themeVariables: {
          primaryColor:'#161b22', primaryTextColor:'#c9d1d9', primaryBorderColor:'#30363d',
          lineColor:'#58a6ff', background:'#0d1117', mainBkg:'#161b22', secondaryColor:'#21262d',
          fontSize:'20px', lineHeight:'1.4'
        }
      } : {
        ...shared,
        theme: 'default',
        themeVariables: {
          primaryColor:'#ffffff', primaryTextColor:'#24292f', primaryBorderColor:'#d0d7de',
          lineColor:'#0969da', tertiaryColor:'#f6f8fa', background:'#ffffff',
          fontSize:'20px', lineHeight:'1.4'
        }
      };
    }

    function installMermaid(dark){
      if (!window.mermaid) return;
      window.mermaid.initialize(currentMermaidConfig(dark));
    }

    // å®¹å™¨ä¿®æ­£ï¼Œé¿å… SVG é”é«˜/æº¢å‡º + viewBox ç¼©æ”¾
    function containerFix(){
      document.querySelectorAll('.mermaid>svg').forEach(svg=>{
        svg.style.display='block';
        svg.style.width='100%';
        svg.style.height='auto';
        svg.style.removeProperty('transform');
        svg.style.removeProperty('min-width');
        svg.style.removeProperty('min-height');
        
        // viewBox ç¼©æ”¾ï¼šæ”¾å¤§å†…å®¹
        const viewBox = svg.getAttribute('viewBox');
        if (viewBox) {
          const [x, y, width, height] = viewBox.split(' ').map(Number);
          const scaleFactor = 0.7; // ç¼©å° viewBox ä½¿å†…å®¹çœ‹èµ·æ¥æ›´å¤§
          svg.setAttribute('viewBox', `${x} ${y} ${width * scaleFactor} ${height * scaleFactor}`);
        }
      });
    }

    // Vditor åˆå§‹åŒ–ï¼ˆå›ºå®šæµ…è‰²å ä½ï¼›çœŸå®ä¸»é¢˜ç”± Native æ³¨å…¥ï¼‰
    const vditor = new Vditor('vditor', {
      mode: 'ir',
      theme: 'classic',                   // å ä½
      value: '',
      width: '100%',
      height: '100vh',
      cache: { enable: false },
      hotkey: {
        // ç¦ç”¨ Command+E å¿«æ·é”®ï¼Œè®© App ä½¿ç”¨
        'edit-mode': '',
        // å½»åº•ç¦ç”¨æ‰€æœ‰å¯èƒ½çš„ Command+E ç›¸å…³å¿«æ·é”®
        'Ctrl+Alt+E': '',
        'Shift+Ctrl+E': '',
        'Ctrl+E': '',
        // ğŸ”¥ ç¦ç”¨ Command+Oã€Command+L å’Œ Command+Dï¼Œè®©åº”ç”¨å±‚æ¥ç®¡
        'Cmd+O': '',
        'Ctrl+O': '',
        'Cmd+D': '',
        'Ctrl+D': '',
        'Cmd+L': '',
        'Ctrl+L': '',
        // ç¦ç”¨å¯èƒ½çš„ç»„åˆé”®
        'Cmd+Shift+O': '',
        'Cmd+Shift+L': '',
        'Ctrl+Shift+O': '',
        'Ctrl+Shift+L': ''
      },
      after(){
        // é€šçŸ¥ Nativeï¼šready
        try { window.webkit?.messageHandlers?.bridge?.postMessage({ type: 'ready' }); } catch(_) {}
        setTimeout(containerFix, 30);
        
        // æ‹¦æˆªç‰¹æ®Šå¿«æ·é”®
        document.addEventListener('keydown', function(e) {
          // Command+E: è½¬å‘ç»™åŸç”Ÿ App
          if (e.metaKey && (e.key === 'e' || e.key === 'E')) {
            console.log('æ‹¦æˆª Command+E å¿«æ·é”®ï¼Œè½¬å‘ç»™ App å¤„ç†');
            e.preventDefault();
            e.stopImmediatePropagation();
            
            try {
              window.webkit?.messageHandlers?.bridge?.postMessage({ 
                type: 'commandE'
              });
            } catch(err) {
              console.error('æ— æ³•å‘é€ Command+E äº‹ä»¶:', err);
            }
            return false;
          }
          
          // Command+O: è½¬å‘ç»™åŸç”ŸAppå¤„ç†
          if (e.metaKey && (e.key === 'o' || e.key === 'O')) {
            console.log('ğŸ”¥ æ‹¦æˆª Command+O å¿«æ·é”®ï¼Œè½¬å‘ç»™Appå¤„ç†');
            e.preventDefault();
            e.stopImmediatePropagation();
            
            try {
              window.webkit?.messageHandlers?.bridge?.postMessage({ 
                type: 'commandO'
              });
            } catch(err) {
              console.error('æ— æ³•å‘é€ Command+O äº‹ä»¶:', err);
            }
            return false;
          }
          
          // Command+L: è½¬å‘ç»™åŸç”ŸAppå¤„ç†
          if (e.metaKey && (e.key === 'l' || e.key === 'L')) {
            console.log('ğŸ”¥ æ‹¦æˆª Command+L å¿«æ·é”®ï¼Œè½¬å‘ç»™Appå¤„ç†');
            e.preventDefault();
            e.stopImmediatePropagation();
            
            try {
              window.webkit?.messageHandlers?.bridge?.postMessage({ 
                type: 'commandL'
              });
            } catch(err) {
              console.error('æ— æ³•å‘é€ Command+L äº‹ä»¶:', err);
            }
            return false;
          }
          
          // Command+D: è½¬å‘ç»™åŸç”ŸAppå¤„ç† (å…¨å±è¯¦æƒ…é¢æ¿)
          if (e.metaKey && (e.key === 'd' || e.key === 'D')) {
            console.log('ğŸ”¥ æ‹¦æˆª Command+D å¿«æ·é”®ï¼Œè½¬å‘ç»™Appå¤„ç†');
            e.preventDefault();
            e.stopImmediatePropagation();
            
            try {
              window.webkit?.messageHandlers?.bridge?.postMessage({ 
                type: 'commandD'
              });
            } catch(err) {
              console.error('æ— æ³•å‘é€ Command+D äº‹ä»¶:', err);
            }
            return false;
          }
          
          // Command+/: åˆ‡æ¢ç¼–è¾‘æ¨¡å¼
          if (e.metaKey && e.key === '/') {
            console.log('ğŸ¯ æ‹¦æˆª Command+/ å¿«æ·é”®ï¼Œå‡†å¤‡åˆ‡æ¢ç¼–è¾‘æ¨¡å¼');
            console.log('æŒ‰é”®ä¿¡æ¯:', { key: e.key, metaKey: e.metaKey, ctrlKey: e.ctrlKey, altKey: e.altKey });
            e.preventDefault();
            e.stopImmediatePropagation();
            
            try {
              if (window.__toggleVditorMode) {
                console.log('ğŸ”„ è°ƒç”¨ __toggleVditorMode å‡½æ•°');
                window.__toggleVditorMode();
              } else {
                console.error('âŒ __toggleVditorMode å‡½æ•°ä¸å­˜åœ¨');
              }
            } catch(err) {
              console.error('âŒ æ— æ³•åˆ‡æ¢ç¼–è¾‘æ¨¡å¼:', err);
            }
            return false;
          }
        }, true);
      },
      preview: {
        theme: { current: 'light' },      // å ä½
        hljs: { enable: true, style: 'github' },
        math: { engine: 'KaTeX' },
        mermaid: { startOnLoad:false }     // ç”±æˆ‘ä»¬æ‰‹åŠ¨æ§åˆ¶
      },
      toolbar: ['emoji','headings','bold','italic','strike','link','|','list','ordered-list','check','outdent','indent','|','quote','line','code','inline-code','insert-before','insert-after','|','upload','table','|','undo','redo','|','fullscreen','edit-mode','both','preview','outline','code-theme' ],
      upload: { 
        accept:'image/*',
        async handler(files) {
          // è‡ªå®šä¹‰ä¸Šä¼ å¤„ç†
          const file = files[0];
          if (!file) return;
          
          try {
            // ç”Ÿæˆå”¯ä¸€æ–‡ä»¶å
            const timestamp = Date.now();
            const ext = file.name.split('.').pop() || 'jpg';
            const fileName = `img_${timestamp}.${ext}`;
            
            // æ˜¾ç¤ºåŠ è½½æç¤º
            vditor.insertValue(`![åŠ è½½ä¸­...]()`);
            
            // è¯»å–æ–‡ä»¶
            const reader = new FileReader();
            reader.onload = (e) => {
              const base64 = e.target.result.split(',')[1]; // å»æ‰ data:image/xxx;base64, å‰ç¼€
              
              // å‘é€åˆ° Swift ä¿å­˜
              window.webkit?.messageHandlers?.bridge?.postMessage({ 
                type: 'saveImage',
                fileName: fileName,
                data: base64
              });
              
              // è®¾ç½®å›è°ƒå¤„ç†
              window.__onImageSaved = (name, path) => {
                // æ›¿æ¢åŠ è½½æç¤ºä¸ºå®é™…å›¾ç‰‡è·¯å¾„ï¼ˆä½¿ç”¨ç›¸å¯¹è·¯å¾„ï¼‰
                const content = vditor.getValue();
                const updated = content.replace('![åŠ è½½ä¸­...]()', `![${file.name}](${path})`);
                vditor.setValue(updated);
              };
              
              window.__onImageSaveError = (name, error) => {
                alert(`ä¿å­˜å›¾ç‰‡å¤±è´¥: ${error}`);
                const content = vditor.getValue();
                const updated = content.replace('![åŠ è½½ä¸­...]()', '');
                vditor.setValue(updated);
              };
            };
            
            reader.readAsDataURL(file);
          } catch (error) {
            console.error('å¤„ç†å›¾ç‰‡å¤±è´¥:', error);
            alert('å¤„ç†å›¾ç‰‡å¤±è´¥');
          }
          
          return null; // é˜»æ­¢é»˜è®¤å¤„ç†
        }
      },
      input(value){
        clearTimeout(window.__inputDebounce);
        window.__inputDebounce = setTimeout(()=>{
          // è·å–åŸå§‹ Markdown å†…å®¹ï¼ˆgetValue å·²ç»å¤„ç†äº†è¿˜åŸï¼‰
          const originalValue = vditor.getValue();
          console.log('Input event - sending value:', originalValue.substring(0, 100) + '...');
          try { 
            window.webkit?.messageHandlers?.bridge?.postMessage({ 
              type:'change', 
              value: originalValue 
            }); 
          } catch(e) {
            console.error('Failed to send change message:', e);
          }
        }, 50); // ç¼©çŸ­é˜²æŠ–æ—¶é—´åˆ°50msï¼Œæé«˜å“åº”é€Ÿåº¦
      },
      // æ·»åŠ  blur äº‹ä»¶å¤„ç†ï¼Œç¡®ä¿å¤±ç„¦æ—¶ç«‹å³ä¿å­˜
      blur() {
        clearTimeout(window.__inputDebounce);
        const originalValue = vditor.getValue();
        console.log('Blur event - immediately sending value');
        try { 
          window.webkit?.messageHandlers?.bridge?.postMessage({ 
            type:'change', 
            value: originalValue 
          }); 
        } catch(e) {
          console.error('Failed to send change message on blur:', e);
        }
      }
    });
    window.vditor = vditor;
    
    // å®ç°è‡ªå®šä¹‰å›¾ç‰‡ç¼©æ”¾è¯­æ³•
    // æ”¯æŒæ ¼å¼ï¼š
    // ![alt|50](src)      - ç¼©æ”¾åˆ° 50%
    // ![alt|75.5](src)    - ç¼©æ”¾åˆ° 75.5%
    // ![alt|300px](src)   - å›ºå®šå®½åº¦ 300 åƒç´ 
    const processImageScale = (markdown) => {
      return markdown.replace(/!\[([^\]]*?)\|([0-9.]+)(px)?\]\(([^)]+)\)/g, (match, alt, size, unit, src) => {
        // å¦‚æœæœ‰ px å•ä½ï¼Œä½¿ç”¨åƒç´ ï¼›å¦åˆ™ä½¿ç”¨ç™¾åˆ†æ¯”
        const style = unit === 'px' 
          ? `width: ${size}px; height: auto; max-width: 100%;`
          : `width: ${size}%; height: auto; max-width: 100%;`;
        // ä¿ç•™åŸå§‹ alt æ–‡æœ¬ï¼ˆå»æ‰ç¼©æ”¾å‚æ•°ï¼‰
        return `<img src="${src}" alt="${alt}" style="${style}" title="${alt}" />`;
      });
    };
    
    // ä¿å­˜åŸå§‹ Markdown ç”¨äºç¼–è¾‘
    let originalMarkdown = { current: '' };
    
    // é‡å†™ setValue ä»¥æ”¯æŒç¼©æ”¾è¯­æ³•
    const originalSetValue = vditor.setValue.bind(vditor);
    vditor.setValue = function(value) {
      // ä¿å­˜åŸå§‹å†…å®¹
      originalMarkdown.current = value;
      // å¤„ç†ç¼©æ”¾è¯­æ³•ä»…ç”¨äºæ˜¾ç¤º
      const processed = processImageScale(value);
      originalSetValue(processed);
    };
    
    // ç¡®ä¿ input äº‹ä»¶ä¹Ÿå¤„ç†ç¼©æ”¾
    const originalInsertValue = vditor.insertValue.bind(vditor);
    vditor.insertValue = function(value) {
      const processed = processImageScale(value);
      originalInsertValue(processed);
    };
    
    // é‡å†™ getValue è¿”å›åŸå§‹å†…å®¹
    const originalGetValue = vditor.getValue.bind(vditor);
    vditor.getValue = function() {
      // è·å–å½“å‰ç¼–è¾‘å™¨å†…å®¹
      const currentValue = originalGetValue();
      // å¦‚æœå†…å®¹åŒ…å«æˆ‘ä»¬çš„ HTML img æ ‡ç­¾ï¼Œå°è¯•è¿˜åŸ
      if (currentValue.includes('<img')) {
        // è¿˜åŸ img æ ‡ç­¾ä¸º Markdown æ ¼å¼
        return currentValue.replace(/<img src="([^"]+)" alt="([^"]*)" style="width: (\d+(?:\.\d+)?)(px|%);[^"]*"[^>]*>/g, 
          (match, src, alt, size, unit) => {
            const suffix = unit === 'px' ? 'px' : '';
            return `![${alt}|${size}${suffix}](${src})`;
          });
      }
      return currentValue;
    };
    
    // ç›‘å¬å›¾ç‰‡åŠ è½½äº‹ä»¶è¿›è¡Œè°ƒè¯•
    document.addEventListener('error', function(e) {
      if (e.target.tagName === 'IMG') {
        console.error('å›¾ç‰‡åŠ è½½å¤±è´¥:', e.target.src);
        // å°è¯•ä¿®å¤è·¯å¾„
        const src = e.target.src;
        if (src.includes('Images/') && !src.startsWith('file://')) {
          // å¦‚æœä¸æ˜¯ file:// å¼€å¤´ï¼Œå°è¯•è½¬æ¢
          const filename = src.split('Images/').pop();
          e.target.src = 'Images/' + filename;
        }
      }
    }, true);
    
    // å›¾ç‰‡äº¤äº’å¤„ç†ï¼šæ”¯æŒåŒå‡»æ”¾å¤§ã€Command+ç‚¹å‡»åœ¨Finderä¸­æ˜¾ç¤ºã€åœ¨æ–‡æ¡£å†…ç¼©æ”¾æ‹–åŠ¨
    let imageClickTimeout = null;
    let imageClickCount = 0;
    
    // æ·»åŠ å›¾ç‰‡ç¼©æ”¾çŠ¶æ€ç®¡ç†
    let scaledImages = new Map(); // å­˜å‚¨æ¯ä¸ªå›¾ç‰‡çš„ç¼©æ”¾çŠ¶æ€
    
    // åˆ›å»ºå…¨å±è¦†ç›–å±‚ï¼ˆç”¨äºé€€å‡ºç¼©æ”¾æ¨¡å¼ï¼‰
    function createImageOverlay(img) {
      const overlay = document.createElement('div');
      overlay.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(0, 0, 0, 0.8);
        z-index: 10000;
        cursor: zoom-out;
        display: flex;
        align-items: center;
        justify-content: center;
      `;
      
      const clonedImg = img.cloneNode(true);
      clonedImg.style.cssText = `
        max-width: 90vw;
        max-height: 90vh;
        width: auto;
        height: auto;
        object-fit: contain;
        transform-origin: center;
        transition: none;  // ç§»é™¤é»˜è®¤è¿‡æ¸¡ï¼Œå‡å°‘å»¶è¿Ÿ
        cursor: grab;
      `;
      
      let scale = 1;
      let translateX = 0;
      let translateY = 0;
      let isDragging = false;
      let startX = 0;
      let startY = 0;
      
      // æ›´æ–°å˜æ¢
      function updateTransform() {
        clonedImg.style.transform = `scale(${scale}) translate(${translateX}px, ${translateY}px)`;
      }
      
      // çœŸæ­£çš„æåˆç¼©æ”¾æ”¯æŒ
      let initialDistance = 0;
      let initialScale = 1;
      let isGesturing = false;
      
      // Gestureäº‹ä»¶æ”¯æŒï¼ˆSafari/WebKitï¼‰
      overlay.addEventListener('gesturestart', (e) => {
        e.preventDefault();
        isGesturing = true;
        initialScale = scale;
        clonedImg.style.transition = 'none';
      });
      
      overlay.addEventListener('gesturechange', (e) => {
        e.preventDefault();
        if (isGesturing) {
          const newScale = initialScale * e.scale;
          scale = Math.max(0.5, Math.min(5, newScale));
          updateTransform();
        }
      });
      
      overlay.addEventListener('gestureend', (e) => {
        e.preventDefault();
        isGesturing = false;
        // ç§»é™¤è¿‡æ¸¡åŠ¨ç”»ï¼Œå‡å°‘é‡Šæ”¾å»¶è¿Ÿ
      });
      
      // åŒæŒ‡è§¦æ‘¸æåˆç¼©æ”¾ï¼ˆé€šç”¨æ”¯æŒï¼‰
      let touches = {};
      
      overlay.addEventListener('touchstart', (e) => {
        e.preventDefault();
        if (e.touches.length === 2) {
          // åŒæŒ‡æåˆå¼€å§‹
          const touch1 = e.touches[0];
          const touch2 = e.touches[1];
          initialDistance = Math.sqrt(
            Math.pow(touch2.clientX - touch1.clientX, 2) + 
            Math.pow(touch2.clientY - touch1.clientY, 2)
          );
          initialScale = scale;
          clonedImg.style.transition = 'none';
          isGesturing = true;
        } else if (e.touches.length === 1 && !isGesturing) {
          // å•æŒ‡æ‹–æ‹½
          const touch = e.touches[0];
          lastTouchX = touch.clientX;
          lastTouchY = touch.clientY;
          isTouchDragging = true;
          clonedImg.style.transition = 'none';
        }
      });
      
      overlay.addEventListener('touchmove', (e) => {
        e.preventDefault();
        
        if (e.touches.length === 2 && isGesturing) {
          // åŒæŒ‡æåˆç¼©æ”¾
          const touch1 = e.touches[0];
          const touch2 = e.touches[1];
          const currentDistance = Math.sqrt(
            Math.pow(touch2.clientX - touch1.clientX, 2) + 
            Math.pow(touch2.clientY - touch1.clientY, 2)
          );
          
          if (initialDistance > 0) {
            const scaleRatio = currentDistance / initialDistance;
            const newScale = initialScale * scaleRatio;
            scale = Math.max(0.5, Math.min(5, newScale));
            updateTransform();
          }
        } else if (e.touches.length === 1 && isTouchDragging && !isGesturing) {
          // å•æŒ‡æ‹–æ‹½ - è¿›ä¸€æ­¥é™ä½çµæ•åº¦
          const touch = e.touches[0];
          const deltaX = (touch.clientX - lastTouchX) * 0.4;  // é™ä½åˆ°40%çµæ•åº¦
          const deltaY = (touch.clientY - lastTouchY) * 0.4;  // é™ä½åˆ°40%çµæ•åº¦
          
          translateX += deltaX;
          translateY += deltaY;
          
          lastTouchX = touch.clientX;
          lastTouchY = touch.clientY;
          updateTransform();
        }
      });
      
      overlay.addEventListener('touchend', (e) => {
        e.preventDefault();
        if (e.touches.length < 2) {
          isGesturing = false;
          initialDistance = 0;
        }
        if (e.touches.length === 0) {
          isTouchDragging = false;
        }
        // ç§»é™¤è¿‡æ¸¡åŠ¨ç”»ï¼Œå‡å°‘é‡Šæ”¾å»¶è¿Ÿ
      });
      
      // é¼ æ ‡æ»šè½®ç¼©æ”¾ï¼ˆæ”¯æŒè§¦æ§æ¿æåˆï¼‰
      overlay.addEventListener('wheel', (e) => {
        e.preventDefault();
        
        // æ£€æµ‹æ˜¯å¦æ˜¯è§¦æ§æ¿æåˆæ‰‹åŠ¿ï¼ˆctrlKeyä¸ºtrueè¡¨ç¤ºæåˆï¼‰
        if (e.ctrlKey) {
          // è§¦æ§æ¿æåˆç¼©æ”¾ï¼Œæ›´ç²¾ç»†çš„æ§åˆ¶
          const delta = -e.deltaY * 0.01;
          scale = Math.max(0.5, Math.min(5, scale * (1 + delta)));
        } else {
          // æ™®é€šæ»šè½®ç¼©æ”¾
          const delta = e.deltaY > 0 ? 0.9 : 1.1;
          scale = Math.max(0.5, Math.min(5, scale * delta));
        }
        updateTransform();
      });
      
      // è§¦æ‘¸å˜é‡å£°æ˜ï¼ˆç”¨äºä¸Šé¢çš„è§¦æ‘¸äº‹ä»¶ï¼‰
      let lastTouchX = 0;
      let lastTouchY = 0;
      let isTouchDragging = false;
      
      // æ‹–æ‹½åŠŸèƒ½
      clonedImg.addEventListener('mousedown', (e) => {
        if (e.button === 0) {
          e.preventDefault();
          isDragging = true;
          startX = e.clientX - translateX;
          startY = e.clientY - translateY;
          clonedImg.style.cursor = 'grabbing';
          clonedImg.style.transition = 'none';
        }
      });
      
      overlay.addEventListener('mousemove', (e) => {
        if (isDragging) {
          translateX = e.clientX - startX;
          translateY = e.clientY - startY;
          updateTransform();
        }
      });
      
      overlay.addEventListener('mouseup', () => {
        if (isDragging) {
          isDragging = false;
          clonedImg.style.cursor = 'grab';
          // ç§»é™¤è¿‡æ¸¡åŠ¨ç”»ï¼Œå‡å°‘é¼ æ ‡é‡Šæ”¾å»¶è¿Ÿ
        }
      });
      
      // åŒå‡»é‡ç½®
      clonedImg.addEventListener('dblclick', (e) => {
        e.stopPropagation();
        scale = 1;
        translateX = 0;
        translateY = 0;
        updateTransform();
      });
      
      // ç‚¹å‡»ç©ºç™½åŒºåŸŸæˆ–ESCé€€å‡º
      overlay.addEventListener('click', (e) => {
        if (e.target === overlay) {
          document.body.removeChild(overlay);
        }
      });
      
      // é”®ç›˜å¿«æ·é”®
      const handleKeyPress = (e) => {
        e.preventDefault();
        switch(e.key) {
          case 'Escape':
            // ESCé€€å‡º - ç«‹å³å…³é—­ï¼Œæ— å»¶è¿Ÿ
            if (document.body.contains(overlay)) {
              document.body.removeChild(overlay);
            }
            document.removeEventListener('keydown', handleKeyPress);
            break;
          case '0':
            // æ•°å­—0é‡ç½®ç¼©æ”¾
            scale = 1;
            translateX = 0;
            translateY = 0;
            updateTransform();
            break;
          case '=':
          case '+':
            // æ”¾å¤§
            scale = Math.min(5, scale * 1.2);
            updateTransform();
            break;
          case '-':
            // ç¼©å°
            scale = Math.max(0.5, scale * 0.8);
            updateTransform();
            break;
          case '1':
            // å®é™…å¤§å°
            scale = 1;
            updateTransform();
            break;
        }
      };
      document.addEventListener('keydown', handleKeyPress);
      
      overlay.appendChild(clonedImg);
      return overlay;
    }
    
    // é˜»æ­¢æ‰€æœ‰å›¾ç‰‡çš„é»˜è®¤åŒå‡»è¡Œä¸ºï¼ˆåŒ…æ‹¬vditorå†…ç½®çš„ï¼‰
    document.addEventListener('dblclick', function(e) {
      if (e.target.tagName === 'IMG') {
        e.preventDefault();
        e.stopImmediatePropagation();
        e.stopPropagation();
      }
    }, true);
    
    // æ·»åŠ æœ€é«˜ä¼˜å…ˆçº§çš„Command+ç‚¹å‡»é“¾æ¥å¤„ç†ï¼ˆcaptureæ¨¡å¼ï¼‰
    document.addEventListener('click', function(e) {
      // ä»…å¤„ç†Command+ç‚¹å‡»çš„é“¾æ¥ï¼Œè®©å…¶ä»–ç‚¹å‡»äº‹ä»¶æ­£å¸¸æµè½¬
      if (e.metaKey) {
        let target = e.target;
        
        // å‘ä¸ŠæŸ¥æ‰¾é“¾æ¥å…ƒç´ 
        while (target && target.tagName !== 'A' && target.parentElement) {
          target = target.parentElement;
        }
        
        if (target && target.tagName === 'A') {
          let url = target.href || target.getAttribute('href');
          if (url) {
            console.log('ğŸ”— [CAPTURE] Command+ç‚¹å‡»é“¾æ¥:', url);
            e.preventDefault();
            e.stopPropagation();
            e.stopImmediatePropagation();
            
            // ç¡®ä¿URLæ ¼å¼æ­£ç¡®
            if (!url.startsWith('http://') && !url.startsWith('https://') && !url.startsWith('mailto:')) {
              if (url.includes('@')) {
                url = 'mailto:' + url;
              } else {
                url = 'https://' + url;
              }
              console.log('ğŸ”— [CAPTURE] è‡ªåŠ¨æ·»åŠ åè®®åçš„URL:', url);
            }
            
            try {
              window.webkit?.messageHandlers?.bridge?.postMessage({ 
                type: 'openURL',
                url: url
              });
              console.log('âœ… [CAPTURE] å·²å‘é€openURLæ¶ˆæ¯åˆ°åŸç”Ÿä»£ç ');
            } catch(err) {
              console.error('âŒ [CAPTURE] æ— æ³•å‘é€openURLæ¶ˆæ¯:', err);
              // å¤‡é€‰æ–¹æ¡ˆ
              try {
                window.open(url, '_blank');
                console.log('âœ… [CAPTURE] å¤‡é€‰æ–¹æ¡ˆï¼šä½¿ç”¨window.openæ‰“å¼€é“¾æ¥');
              } catch(backupErr) {
                console.error('âŒ [CAPTURE] å¤‡é€‰æ–¹æ¡ˆä¹Ÿå¤±è´¥:', backupErr);
              }
            }
            return false;
          }
        }
      }
    }, true); // capture=trueï¼Œæœ€é«˜ä¼˜å…ˆçº§
    
    // æ·»åŠ å¸¸è§„çš„é“¾æ¥ç‚¹å‡»å¤„ç† - bubbleæ¨¡å¼ï¼Œç”¨äºè°ƒè¯•
    document.addEventListener('click', function(e) {
      console.log('ğŸ”— Click event detected, target:', e.target.tagName, 'metaKey:', e.metaKey);
      
      // å¤„ç†è¶…é“¾æ¥çš„Command+ç‚¹å‡» - æé«˜ä¼˜å…ˆçº§å¤„ç†
      let target = e.target;
      
      // å‘ä¸ŠæŸ¥æ‰¾æœ€è¿‘çš„é“¾æ¥å…ƒç´ 
      while (target && target.tagName !== 'A' && target.parentElement) {
        target = target.parentElement;
      }
      
      if (target && target.tagName === 'A') {
        let url = target.href || target.getAttribute('href');
        console.log('ğŸ”— æ‰¾åˆ°é“¾æ¥å…ƒç´ :', target, 'URL:', url, 'metaKey:', e.metaKey);
        
        if (url && e.metaKey) {
          // Command+ç‚¹å‡»é“¾æ¥ï¼šåœ¨é»˜è®¤æµè§ˆå™¨ä¸­æ‰“å¼€
          console.log('ğŸ”— æ£€æµ‹åˆ°Command+ç‚¹å‡»é“¾æ¥:', url);
          e.preventDefault();
          e.stopPropagation();
          e.stopImmediatePropagation();
          
          // ç¡®ä¿URLæ ¼å¼æ­£ç¡®
          if (!url.startsWith('http://') && !url.startsWith('https://') && !url.startsWith('mailto:')) {
            if (url.includes('@')) {
              url = 'mailto:' + url;
            } else {
              url = 'https://' + url;
            }
            console.log('ğŸ”— è‡ªåŠ¨æ·»åŠ åè®®åçš„URL:', url);
          }
          
          try {
            // ä½¿ç”¨åŸç”Ÿæ–¹å¼æ‰“å¼€é“¾æ¥
            window.webkit?.messageHandlers?.bridge?.postMessage({ 
              type: 'openURL',
              url: url
            });
            console.log('âœ… å·²å‘é€openURLæ¶ˆæ¯åˆ°åŸç”Ÿä»£ç ');
          } catch(err) {
            console.error('âŒ æ— æ³•å‘é€openURLæ¶ˆæ¯:', err);
            // å¤‡é€‰æ–¹æ¡ˆï¼šä½¿ç”¨window.open
            try {
              window.open(url, '_blank');
              console.log('âœ… å¤‡é€‰æ–¹æ¡ˆï¼šä½¿ç”¨window.openæ‰“å¼€é“¾æ¥');
            } catch(backupErr) {
              console.error('âŒ å¤‡é€‰æ–¹æ¡ˆä¹Ÿå¤±è´¥:', backupErr);
            }
          }
          return false;
        } else if (url) {
          console.log('ğŸ”— æ™®é€šé“¾æ¥ç‚¹å‡»ï¼ˆéCommand+ç‚¹å‡»ï¼‰:', url);
        }
      }
      
      if (e.target.tagName === 'IMG' && e.target.src.includes('Images/')) {
        if (e.metaKey) {
          // Command+ç‚¹å‡»ï¼šåœ¨ Finder ä¸­æ˜¾ç¤ºå›¾ç‰‡
          e.preventDefault();
          e.stopPropagation();
          const src = e.target.src;
          const filename = src.split('Images/').pop();
          try {
            window.webkit?.messageHandlers?.bridge?.postMessage({ 
              type: 'showImageInFinder',
              filename: 'Images/' + filename
            });
          } catch(err) {
            console.error('æ— æ³•æ‰“å¼€å›¾ç‰‡:', err);
          }
        } else {
          // æ™®é€šç‚¹å‡»ï¼šå¤„ç†åŒå‡»æ£€æµ‹
          e.preventDefault();
          e.stopPropagation();
          
          imageClickCount++;
          const currentImg = e.target;
          
          if (imageClickCount === 1) {
            imageClickTimeout = setTimeout(() => {
              // å•å‡»ï¼šä¸åšä»»ä½•æ“ä½œ
              console.log('å•å‡»å›¾ç‰‡');
              imageClickCount = 0;
            }, 300);
          } else if (imageClickCount === 2) {
            // åŒå‡»ï¼šè¿›å…¥ç¼©æ”¾æ¨¡å¼
            clearTimeout(imageClickTimeout);
            imageClickCount = 0;
            
            console.log('åŒå‡»å›¾ç‰‡ï¼Œè¿›å…¥ç¼©æ”¾æ¨¡å¼');
            const overlay = createImageOverlay(currentImg);
            document.body.appendChild(overlay);
            
            // ç«‹å³æ˜¾ç¤ºï¼Œæ— æ·¡å…¥åŠ¨ç”»
            overlay.style.opacity = '1';
          }
        }
      }
    });

    // åŠ¨æ€è°ƒæ•´ Mermaid åŸºå‡†å­—å·ï¼ˆæ•´ä½“ç¼©æ”¾ï¼‰
    window.__setMermaidFont = function(px){
      try {
        document.documentElement.style.setProperty('--mmd-font', typeof px === 'number' ? px + 'px' : String(px));
        const val = vditor.getValue();
        if (val != null) vditor.setValue(val); // è§¦å‘é¢„è§ˆé‡ç®—
      } catch(_) {}
      setTimeout(containerFix, 60);
    };

    // Native å”¯ä¸€å…¥å£ï¼šåº”ç”¨ä¸»é¢˜ + è§¦å‘é‡æ¸²æŸ“
    window.__applyNativeTheme = function(dark){
      try {
        const ui = dark ? 'dark' : 'classic';
        const code = dark ? 'github-dark' : 'github';
        const content = dark ? 'dark' : 'light';
        if (vditor.setTheme) vditor.setTheme(ui, code, content);
      } catch(_) {}
      installMermaid(dark);
      try {
        const val = vditor.getValue();
        if (val != null) vditor.setValue(val); // è§¦å‘é¢„è§ˆï¼ˆå« mermaidï¼‰é‡ç®—
      } catch(_) {}
      setTimeout(containerFix, 60);
    };

    // è®¾ç½®/å¼ºåˆ¶è®¾ç½® Markdown
    window.__setMarkdown = function(text, force){
      try{
        const cur = vditor.getValue();
        if (force || cur !== text) vditor.setValue(text);
      }catch(_){}
    };

    // åˆ‡æ¢ç¼–è¾‘æ¨¡å¼ï¼ˆIR <-> SV åˆ†å±é¢„è§ˆï¼‰
    let currentEditMode = 'ir'; // è·Ÿè¸ªå½“å‰æ¨¡å¼ï¼Œé»˜è®¤ä¸ºå³æ—¶æ¸²æŸ“(8)
    
    window.__toggleVditorMode = function(){
      try{
        console.log('ğŸ”„ å¼€å§‹åˆ‡æ¢ç¼–è¾‘æ¨¡å¼...');
        console.log('å½“å‰æ¨¡å¼:', currentEditMode);
        
        // é¦–å…ˆç‚¹å‡»ç¼–è¾‘æ¨¡å¼æŒ‰é’®æ‰“å¼€ä¸‹æ‹‰èœå•
        const editModeBtn = document.querySelector('[data-type="edit-mode"]');
        if (editModeBtn) {
          console.log('æ‰¾åˆ°ç¼–è¾‘æ¨¡å¼æŒ‰é’®');
          editModeBtn.click();
          
          // ç­‰å¾…ä¸‹æ‹‰èœå•å‡ºç°ï¼Œç„¶åé€‰æ‹©å¯¹åº”çš„æ¨¡å¼
          setTimeout(() => {
            if (currentEditMode === 'ir') {
              // ä» IR(8) åˆ‡æ¢åˆ° SV(9) åˆ†å±é¢„è§ˆ
              const svBtn = document.querySelector('[data-mode="sv"]');
              if (svBtn) {
                console.log('åˆ‡æ¢åˆ° SV åˆ†å±é¢„è§ˆæ¨¡å¼');
                svBtn.click();
                currentEditMode = 'sv';
              } else {
                console.error('âŒ æ‰¾ä¸åˆ° SV æŒ‰é’®');
                // å¦‚æœæ‰¾ä¸åˆ°SVæŒ‰é’®ï¼Œå°è¯•æŸ¥æ‰¾æ‰€æœ‰å¯ç”¨çš„æ¨¡å¼æŒ‰é’®
                const allModeButtons = document.querySelectorAll('[data-mode]');
                console.log('å¯ç”¨çš„æ¨¡å¼æŒ‰é’®:', Array.from(allModeButtons).map(btn => btn.getAttribute('data-mode')));
              }
            } else {
              // ä» SV(9) åˆ‡æ¢å› IR(8)
              const irBtn = document.querySelector('[data-mode="ir"]');
              if (irBtn) {
                console.log('åˆ‡æ¢åˆ° IR å³æ—¶æ¸²æŸ“æ¨¡å¼');
                irBtn.click();
                currentEditMode = 'ir';
              } else {
                console.error('âŒ æ‰¾ä¸åˆ° IR æŒ‰é’®');
              }
            }
            
            console.log('âœ… æ¨¡å¼åˆ‡æ¢å®Œæˆï¼Œå½“å‰æ¨¡å¼:', currentEditMode);
          }, 100); // ç»™ä¸‹æ‹‰èœå•ä¸€ç‚¹æ—¶é—´æ˜¾ç¤º
        } else {
          console.error('âŒ æ‰¾ä¸åˆ°ç¼–è¾‘æ¨¡å¼åˆ‡æ¢æŒ‰é’®');
        }
      }catch(e){
        console.error('âŒ åˆ‡æ¢æ¨¡å¼å¤±è´¥:', e);
      }
    };
  })();
  </script>
</body>
</html>